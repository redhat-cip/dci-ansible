---
- hosts: localhost
  tasks:
    - name: Retrieve topics
      dci_topic:
      register: all_topics

    - name: Create new component
      dci_component:
        name: "RH7-RHOS-{{ item.name }}-2018-01-13"
        type: puddles
        canonical_project_name: "RH7-RHOS-{{ item.name }}.0-2018-01-13"
        url: https://www.example.com
        topic_id: '{{ item.id }}'
      register: components
      with_items: '{{ all_topics.topics }}'

    - name: Register content of the uploaded file
      command: "cat {{ lookup('env', 'PWD')  }}/data/content"
      register: component_file_before_upload

    - name: Upload the component content
      dci_component:
        id: '{{ item.component.id }}'
        path: "{{ lookup('env', 'PWD')  }}/data/content"
      with_items: "{{ components.results }}"

    - name: Download component content
      dci_component:
        id: '{{ item.component.id }}'
        dest: "{{ lookup('env', 'PWD')  }}/content.download"
      with_items: "{{ components.results }}"

    - name: Register content of the download file
      command: "cat {{ lookup('env', 'PWD')  }}/content.download"
      register: component_file_after_download

    - name: Ensure proper file has been downloaded
      assert:
        that: component_file_before_upload.stdout == component_file_after_download.stdout

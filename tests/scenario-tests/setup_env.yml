---
- hosts: localhost
  tasks:
    - name: Retrieve PRODUCT_OWNER role
      dci_role:
        where: label:PRODUCT_OWNER
      register: po_role

    - name: Create Product Team
      dci_team:
        name: OpenStack
      register: openstack_team

    - name: Create Product
      dci_product:
        name: OpenStack
        description: OpenStack is a free and open-source software platform for cloud computing,
        team_id: '{{ openstack_team.team.id }}'
      register: openstack_product

    - name: Create an OSP13 topic
      dci_topic:
        name: OSP13
        component_types:
          - puddles
        product_id: '{{ openstack_product.product.id }}'
        data:
          releasename: queens
      register: openstack_topic_osp13

    - name: Attach OpenStack team to OSP13 topic
      dci_topic:
        id: '{{ openstack_topic_osp13.topic.id }}'
        team_ids:
          - '{{ openstack_team.team.id }}'

    - name: Create an OSP12 topic
      dci_topic:
        name: OSP12
        next_topic_id: '{{ openstack_topic_osp13.topic.id }}'
        component_types:
          - puddles
        product_id: '{{ openstack_product.product.id }}'
        data:
          releasename: pike
      register: openstack_topic_osp12

    - name: Attach OpenStack team to OSP12 topic
      dci_topic:
        id: '{{ openstack_topic_osp12.topic.id }}'
        team_ids:
          - '{{ openstack_team.team.id }}'

    - name: Create Product Owner for OpenStack
      dci_user:
        name: openstack-po
        email: openstack-po@distributed-ci.io
        fullname: OpenStack PO
        password: Apassword
        role_id: '{{ po_role.roles[0].id }}'
        team_id: '{{ openstack_team.team.id }}'

    - name: Create a feeder for the OpenStack team
      dci_feeder:
        name: OSP
        team_id: '{{ openstack_team.team.id }}'
      register: osp_feeder

    - name: Create a remoteci for the OpenStack team
      dci_remoteci:
        name: OSP13
        team_id: '{{ openstack_team.team.id }}'
      register: osp13_remoteci

    - name: Generate the feeder.sh file
      blockinfile:
        path: "{{ lookup('env', 'PWD')  }}/feeder.sh"
        mode: 0755
        create: yes
        content: |
          export DCI_CLIENT_ID=feeder/{{ osp_feeder.feeder.id }}
          export DCI_API_SECRET={{ osp_feeder.feeder.api_secret }}

    - name: Generate the remoteci.sh file
      blockinfile:
        path: "{{ lookup('env', 'PWD')  }}/remoteci.sh"
        mode: 0755
        create: yes
        content: |
          export DCI_CLIENT_ID=remoteci/{{ osp13_remoteci.remoteci.id }}
          export DCI_API_SECRET={{ osp13_remoteci.remoteci.api_secret }}


    - name: Create Product Team
      dci_team:
        name: RHEL
      register: rhel_team


## TEMP WORK
    - name: Create Product
      dci_product:
        name: RHEL
        description: Red Hat Enterprise Linux
        team_id: '{{ rhel_team.team.id }}'
      register: rhel_product

    - name: Create a RHEL7 topic
      dci_topic:
        name: rhel7
        component_types:
          - Compose
        product_id: '{{ rhel_product.product.id }}'
      register: rhel_topic_rhel7

    - name: Attach RHEL team to RHEL7 topic
      dci_topic:
        id: '{{ rhel_topic_rhel7.topic.id }}'
        team_ids:
          - '{{ rhel_team.team.id }}'

    - name: Create a remoteci for the RHEL team
      dci_remoteci:
        name: rhel
        team_id: '{{ rhel_team.team.id }}'
      register: rhel_remoteci

    - name: Create new RHEL component
      dci_component:
        name: "RHEL7-Compose-2018.08.03-3"
        type: Compose
        canonical_project_name: "RHEL7-Compose-2018.08.03-3"
        url: https://www.example.com
        topic_id: '{{ rhel_topic_rhel7.topic.id }}'
      register: rhel_component

    - name: Ensure directory exists:
      file:
        state: directory
        recurse: yes
        path: '/repo/{{ rhel_product.product.id }}/{{ rhel_topic_rhel7.topic.id }}/{{ rhel_component.component.id }}'

    - name: Create repodata
      shell: createrepo
      args:
        chdir: '/repo/{{ rhel_product.product.id }}/{{ rhel_topic_rhel7.topic.id }}/{{ rhel_component.component.id }}'
